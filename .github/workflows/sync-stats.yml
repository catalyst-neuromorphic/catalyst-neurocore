name: Sync Stats
on:
  repository_dispatch:
    types: [stats-update]
  schedule:
    - cron: "0 7 * * 1"  # Weekly Monday 7AM UTC
  workflow_dispatch: {}

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.CATALYST_BOT_APP_ID }}
          private-key: ${{ secrets.CATALYST_BOT_PRIVATE_KEY }}
          owner: catalyst-neuromorphic
          repositories: catalyst-neurocore,catalyst-website

      - uses: actions/checkout@v4
        with:
          token: ${{ steps.app-token.outputs.token }}

      - name: Update README stats
        env:
          PAYLOAD: ${{ toJSON(github.event.client_payload) }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          python3 << 'SCRIPT'
          import re, json, os

          payload = os.environ.get("PAYLOAD", "{}")
          event = os.environ.get("EVENT_NAME", "")

          if event == "repository_dispatch" and payload and payload != "null":
              stats = json.loads(payload)
          else:
              stats = {
                  "test_count": "3091",
                  "features_total": "155",
                  "features_full": "152",
                  "features_hw_only": "3",
                  "shd_float": "85.9",
                  "shd_quantized": "85.4",
                  "sdk_version": "3.7.0"
              }

          with open("README.md", "r") as f:
              content = f.read()

          val_map = {
              "TEST_COUNT": f"{int(stats.get('test_count', 3091)):,}",
              "FEATURES_TOTAL": str(stats.get("features_total", "155")),
              "FEATURES_FULL": str(stats.get("features_full", "152")),
              "FEATURES_HW_ONLY": str(stats.get("features_hw_only", "3")),
              "SHD_FLOAT": str(stats.get("shd_float", "85.9")),
              "SHD_QUANT": str(stats.get("shd_quantized", "85.4")),
              "SDK_VERSION": str(stats.get("sdk_version", "3.7.0")),
          }

          for key, val in val_map.items():
              pattern = rf"(<!-- STAT:{key} -->).*?(<!-- /STAT -->)"
              content = re.sub(pattern, rf"\g<1>{val}\g<2>", content)

          with open("README.md", "w") as f:
              f.write(content)

          print("Stats updated in README.md")
          for k, v in val_map.items():
              print(f"  {k}: {v}")
          SCRIPT

      - name: Commit and push
        run: |
          git config user.name "catalyst-ci-bot[bot]"
          git config user.email "catalyst-ci-bot[bot]@users.noreply.github.com"
          git add README.md
          git diff --cached --quiet || git commit -m "chore: sync stats from test suite"
          git push

      - name: Trigger website sync
        if: success()
        env:
          PAYLOAD: ${{ toJSON(github.event.client_payload) }}
        run: |
          curl -X POST \
            -H "Authorization: token ${{ steps.app-token.outputs.token }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/catalyst-neuromorphic/catalyst-website/dispatches \
            -d "{\"event_type\": \"stats-update\", \"client_payload\": $PAYLOAD}"
